<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Sessions</title>
    <link rel="stylesheet" href="styles.css?v=9">
    <!-- Markdown rendering and syntax highlighting for SDK sessions -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <header>
        <h1>Claude Code Sessions</h1>
        <div id="status">
            <span id="session-count">0 sessions</span>
            <span id="last-update">--</span>
            <button id="sound-toggle" class="icon-button" onclick="soundManager.toggle(); soundManager.updateMuteIndicator(); showToast(soundManager.enabled ? 'üîä Sound enabled' : 'üîá Sound muted');" title="Toggle sound (M)">
                üîä
            </button>
            <button id="sound-settings" class="icon-button" onclick="showSoundSettings()" title="Sound settings (Shift+S)">
                ‚öôÔ∏è
            </button>
            <button id="analytics-button" class="icon-button" title="Analytics" onclick="toggleAnalytics()">
                üìä
            </button>
            <button id="machines-button" class="icon-button" title="Manage machines" onclick="showMachinesModal()">
                üñ•Ô∏è
            </button>
            <span id="machine-count" class="machine-count"></span>
            <button id="notification-toggle" class="icon-button" title="Toggle notifications">
                üîî
            </button>
        </div>
    </header>

    <nav class="view-tabs">
        <div class="tab-indicator"></div>
        <button class="tab-button active" onclick="switchView('sessions')" data-view="sessions">
            Sessions
        </button>
        <button class="tab-button" onclick="switchView('gastown')" data-view="gastown">
            üè≠ Gastown
        </button>
        <button class="tab-button" onclick="switchView('timeline')" data-view="timeline">
            Timeline
        </button>
        <button class="tab-button" onclick="switchView('analytics')" data-view="analytics">
            Analytics
        </button>
        <button class="tab-button" onclick="switchView('mission-control')" data-view="mission-control">
            üéõÔ∏è Mission Control
        </button>
        <button class="tab-button" onclick="switchView('graveyard')" data-view="graveyard">
            ü™¶ Graveyard
        </button>
    </nav>

    <div id="main-content" role="main">
    <div id="sessions-view" class="view active">
        <div id="filters">
            <input type="text" id="search" placeholder="üîç Search sessions...">
            <select id="status-filter">
                <option value="all">All Sessions</option>
                <option value="active">Active Only</option>
                <option value="waiting">Waiting Only</option>
            </select>
            <button id="clear-filters">Clear</button>
            <div class="filter-divider"></div>
            <button id="view-mode-toggle" class="icon-button" onclick="toggleCardMode()" title="Toggle compact/detailed view (v)">üìã</button>
            <button id="focus-mode-toggle" class="icon-button" onclick="toggleFocusMode()" title="Focus on active sessions (f)">üéØ</button>
            <button id="refresh-sessions" class="icon-button" onclick="forceRefreshSessions()" title="Refresh all session data">üîÑ</button>
        </div>
        <main id="sessions-container"></main>
    </div>

    <div id="gastown-view" class="view">
        <div class="gastown-view-header">
            <h2>üè≠ Gastown Agents</h2>
            <span id="gastown-count" class="gastown-stats"></span>
        </div>
        <main id="gastown-container"></main>
    </div>

    <div id="timeline-view" class="view">
        <div class="timeline-header">
            <h2>Session Timeline</h2>
            <div class="timeline-controls">
                <select id="timeline-range-select" class="timeline-range-select" onchange="changeTimelineRange(this.value)">
                    <option value="1">Last 1 hour</option>
                    <option value="2">Last 2 hours</option>
                    <option value="4">Last 4 hours</option>
                    <option value="8" selected>Last 8 hours</option>
                    <option value="12">Last 12 hours</option>
                    <option value="24">Last 24 hours</option>
                    <option value="48">Last 2 days</option>
                </select>
                <button class="refresh-btn" onclick="refreshTimeline()" title="Refresh timeline">üîÑ</button>
            </div>
        </div>
        <div class="timeline-legend">
            <span class="legend-item"><span class="legend-dot active"></span> Active</span>
            <span class="legend-item"><span class="legend-dot waiting"></span> Waiting</span>
            <span class="legend-item"><span class="legend-dot closed"></span> Closed</span>
        </div>
        <div id="timeline-container" class="timeline-container">
            <div class="timeline-loading">Loading timeline...</div>
        </div>
    </div>

    <div id="analytics-view" class="view">
        <div class="analytics-header">
            <h2>Usage Analytics</h2>
            <div class="period-selector">
                <button class="period-btn" data-period="day">Today</button>
                <button class="period-btn active" data-period="week">Week</button>
                <button class="period-btn" data-period="month">Month</button>
                <button class="period-btn" data-period="year">Year</button>
            </div>
        </div>
        <div id="analytics-container"></div>
    </div>

    <div id="mission-control-view" class="view">
        <div class="mission-control-header">
            <h2>üéõÔ∏è Mission Control</h2>
            <div class="mission-control-status">
                <div class="mc-sdk-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="mc-sdk-mode" onchange="toggleSDKMode(this.checked)">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">SDK</span>
                    </label>
                    <span id="mc-sdk-status" class="sdk-status"></span>
                </div>
                <span id="mc-connection-status" class="mc-status-indicator">‚óè Disconnected</span>
                <button id="mc-refresh" class="icon-button" title="Refresh">üîÑ</button>
            </div>
        </div>
        <div class="mission-control-grid">
            <div class="mc-panel mc-sessions-panel">
                <div class="mc-panel-header">
                    <h3>Active Sessions</h3>
                    <div class="mc-panel-header-actions">
                        <span id="mc-active-count" class="mc-count">0</span>
                        <button id="mc-spawn-btn" class="mc-spawn-btn" onclick="showSpawnModal()" title="Spawn new Claude session">
                            + New
                        </button>
                    </div>
                </div>
                <div id="mc-sessions-list" class="mc-panel-content">
                    <div class="mc-empty">No active sessions</div>
                </div>
            </div>
            <div class="mc-panel mc-conversation-panel">
                <div class="mc-panel-header">
                    <h3 id="mc-panel-title">Live Conversation</h3>
                    <div class="mc-panel-header-right">
                        <span id="mc-session-type" class="mc-session-type-badge hidden"></span>
                        <span id="mc-selected-session" class="mc-selected-label">Select a session</span>
                        <button id="mc-kill-btn" class="mc-kill-btn hidden" onclick="killSelectedProcess()" title="Stop process">
                            Stop
                        </button>
                    </div>
                </div>
                <div id="mc-conversation-stream" class="mc-panel-content mc-conversation-stream">
                    <div class="mc-empty">Select a session to view conversation</div>
                </div>
                <div id="mc-terminal-output" class="mc-panel-content mc-terminal-output hidden">
                    <div class="mc-terminal-content"></div>
                </div>
                <div id="mc-input-container" class="mc-input-container hidden">
                    <!-- Toolbar row with context indicator, modes, and compact -->
                    <div class="mc-toolbar">
                        <!-- Context usage indicator -->
                        <div class="mc-context-indicator" title="Context window usage">
                            <div class="mc-context-bar">
                                <div id="mc-context-fill" class="mc-context-fill" style="width: 0%"></div>
                            </div>
                            <span id="mc-context-label" class="mc-context-label">0%</span>
                        </div>

                        <!-- Permission mode selector -->
                        <div class="mc-mode-selector">
                            <label class="mc-mode-option">
                                <input type="radio" name="mc-permission-mode" value="normal" checked onchange="setPermissionMode('normal')">
                                <span class="mc-mode-label">Normal</span>
                            </label>
                            <label class="mc-mode-option">
                                <input type="radio" name="mc-permission-mode" value="acceptEdits" onchange="setPermissionMode('acceptEdits')">
                                <span class="mc-mode-label">Accept Edits</span>
                            </label>
                            <label class="mc-mode-option">
                                <input type="radio" name="mc-permission-mode" value="bypassPermissions" onchange="setPermissionMode('bypassPermissions')">
                                <span class="mc-mode-label">Bypass</span>
                            </label>
                            <label class="mc-mode-option">
                                <input type="radio" name="mc-permission-mode" value="planMode" onchange="setPermissionMode('planMode')">
                                <span class="mc-mode-label">Plan</span>
                            </label>
                        </div>

                        <!-- Compact button with optional instructions -->
                        <div class="mc-compact-group">
                            <button id="mc-compact-btn" class="mc-compact-btn" onclick="toggleCompactInput()" title="Compact conversation">
                                üì¶ Compact
                            </button>
                            <div id="mc-compact-input" class="mc-compact-input hidden">
                                <input type="text" id="mc-compact-instructions" placeholder="Optional: focus on..."
                                       onkeydown="if(event.key==='Enter') executeCompact()">
                                <button class="mc-compact-go" onclick="executeCompact()" title="Run compact">Go</button>
                                <button class="mc-compact-cancel" onclick="hideCompactInput()" title="Cancel">√ó</button>
                            </div>
                        </div>
                    </div>

                    <div class="mc-input-wrapper">
                        <button id="mc-commands-btn" class="mc-picker-btn" onclick="toggleCommandsPicker()" title="Browse commands">
                            <span class="mc-picker-icon">/</span>
                        </button>
                        <button id="mc-skills-btn" class="mc-picker-btn" onclick="toggleSkillsPicker()" title="Browse skills">
                            <span class="mc-picker-icon">‚ö°</span>
                        </button>
                        <div id="mc-input" class="mc-input" contenteditable="true"
                             data-placeholder="Type a message..." spellcheck="false"></div>
                        <button id="mc-send-btn" class="mc-send-btn" title="Send (Cmd+Enter)">‚û§</button>
                        <!-- Slash command autocomplete dropdown -->
                        <div id="mc-autocomplete" class="mc-autocomplete hidden"></div>
                        <!-- Commands picker dropdown -->
                        <div id="mc-commands-picker" class="mc-picker-dropdown hidden">
                            <div class="mc-picker-header">
                                <span class="mc-picker-title">/ Commands</span>
                                <button class="mc-picker-close" onclick="hideCommandsPicker()">√ó</button>
                            </div>
                            <div class="mc-picker-search">
                                <input type="text" id="mc-commands-search" placeholder="Search commands..." oninput="filterCommandsPicker(this.value)">
                            </div>
                            <div id="mc-commands-list" class="mc-picker-list"></div>
                        </div>
                        <!-- Skills picker dropdown -->
                        <div id="mc-skills-picker" class="mc-picker-dropdown hidden">
                            <div class="mc-picker-header">
                                <span class="mc-picker-title">‚ö° Skills</span>
                                <button class="mc-picker-close" onclick="hideSkillsPicker()">√ó</button>
                            </div>
                            <div class="mc-picker-search">
                                <input type="text" id="mc-skills-search" placeholder="Search skills..." oninput="filterSkillsPicker(this.value)">
                            </div>
                            <div id="mc-skills-list" class="mc-picker-list"></div>
                        </div>
                    </div>
                    <div class="mc-input-hints">
                        <span>Cmd+Enter to send</span>
                        <span id="mc-input-status"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Spawn Session Modal -->
    <div id="spawn-modal" class="spawn-modal hidden">
        <div class="spawn-modal-content">
            <div class="spawn-modal-header">
                <h3>Spawn New Claude Session</h3>
                <button class="spawn-modal-close" onclick="hideSpawnModal()">&times;</button>
            </div>
            <div class="spawn-modal-body">
                <div class="spawn-input-group">
                    <label for="spawn-directory">Working Directory</label>
                    <div class="spawn-directory-input">
                        <input type="text" id="spawn-directory" placeholder="/path/to/project"
                               onkeydown="if(event.key==='Enter') spawnSession()">
                        <button class="spawn-browse-btn" onclick="browseForFolder()" title="Browse for folder">
                            üìÇ
                        </button>
                    </div>
                </div>
                <div class="spawn-recent-dirs">
                    <label>Recent Directories</label>
                    <div id="spawn-recent-list" class="spawn-recent-list">
                        <div class="spawn-loading">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="spawn-modal-footer">
                <button class="spawn-cancel-btn" onclick="hideSpawnModal()">Cancel</button>
                <button class="spawn-confirm-btn" onclick="spawnSession()">Spawn Session</button>
            </div>
        </div>
    </div>

    <div id="graveyard-view" class="view">
        <div class="graveyard-header">
            <h2>ü™¶ Session Graveyard</h2>
            <div class="graveyard-controls">
                <div class="graveyard-search-container">
                    <input type="text" id="graveyard-search" class="graveyard-search"
                           placeholder="Search sessions..."
                           onkeydown="if(event.key==='Enter') searchGraveyard()">
                    <button class="search-btn" onclick="searchGraveyard()" title="Search">üîç</button>
                    <button id="graveyard-clear-search" class="clear-search-btn hidden"
                            onclick="clearGraveyardSearch()" title="Clear search">‚úï</button>
                    <label class="search-content-toggle" title="Search conversation content (slower)">
                        <input type="checkbox" id="graveyard-search-content">
                        <span>Deep</span>
                    </label>
                </div>
                <select id="graveyard-range-select" class="graveyard-range-select" onchange="refreshGraveyard()">
                    <option value="1">Last 1 hour</option>
                    <option value="2">Last 2 hours</option>
                    <option value="4">Last 4 hours</option>
                    <option value="8">Last 8 hours</option>
                    <option value="24" selected>Last 24 hours</option>
                    <option value="48">Last 2 days</option>
                    <option value="168">Last 7 days</option>
                </select>
                <button class="refresh-btn" onclick="refreshGraveyard()" title="Refresh graveyard">üîÑ</button>
                <span id="graveyard-count" class="graveyard-count">0 sessions</span>
            </div>
        </div>
        <div id="graveyard-container" class="graveyard-container">
            <div class="graveyard-loading">Loading dead sessions...</div>
        </div>
    </div>
    </div> <!-- end main-content -->

    <!-- Modal for keyboard shortcuts and other dialogs -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <!-- Delete Message Confirmation Modal -->
    <div id="delete-message-modal" class="delete-modal hidden">
        <div class="delete-modal-content">
            <div class="delete-modal-header">
                <span class="delete-modal-icon">üóëÔ∏è</span>
                <span class="delete-modal-title">Delete Message</span>
            </div>
            <div class="delete-modal-body">
                <p>Are you sure you want to delete this message?</p>
                <div id="delete-message-preview" class="delete-message-preview"></div>
                <p class="delete-warning">This will permanently remove the message from the conversation history.</p>
            </div>
            <div class="delete-modal-footer">
                <button class="delete-cancel-btn" onclick="hideDeleteModal()">Cancel</button>
                <button class="delete-confirm-btn" onclick="confirmDeleteMessage()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div id="debug-panel" class="debug-panel hidden">
        <div class="debug-panel-header">
            <div class="debug-panel-title">
                <span class="debug-icon">üêõ</span>
                <span>Debug Console</span>
            </div>
            <div class="debug-panel-controls">
                <select id="debug-level-select" class="debug-select" onchange="Logger.setLevel(this.value)">
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO" selected>INFO</option>
                    <option value="WARN">WARN</option>
                    <option value="ERROR">ERROR</option>
                </select>
                <label class="debug-checkbox-label" title="Stream server logs via WebSocket">
                    <input type="checkbox" id="debug-server-logs" onchange="setServerLogsEnabled(this.checked)">
                    <span>Server</span>
                </label>
                <label class="debug-checkbox-label" title="Show timestamps">
                    <input type="checkbox" id="debug-timestamps" checked onchange="Logger.setTimestamps(this.checked)">
                    <span>Time</span>
                </label>
                <button class="debug-btn" onclick="Logger.clearBuffer()" title="Clear logs">Clear</button>
                <button class="debug-btn" onclick="Logger.exportLogs()" title="Export logs to file">Export</button>
                <button class="debug-btn debug-close-btn" onclick="Logger.togglePanel()" title="Close panel">&times;</button>
            </div>
        </div>
        <div class="debug-panel-filters">
            <span class="debug-filter-label">Namespaces:</span>
            <label class="debug-namespace-checkbox"><input type="checkbox" data-ns="ws" checked> WS</label>
            <label class="debug-namespace-checkbox"><input type="checkbox" data-ns="pty" checked> PTY</label>
            <label class="debug-namespace-checkbox"><input type="checkbox" data-ns="session" checked> Session</label>
            <label class="debug-namespace-checkbox"><input type="checkbox" data-ns="api" checked> API</label>
            <label class="debug-namespace-checkbox"><input type="checkbox" data-ns="bedrock" checked> Bedrock</label>
            <label class="debug-namespace-checkbox"><input type="checkbox" data-ns="tunnel" checked> Tunnel</label>
            <label class="debug-namespace-checkbox"><input type="checkbox" data-ns="mc" checked> MC</label>
            <label class="debug-namespace-checkbox"><input type="checkbox" data-ns="app" checked> App</label>
        </div>
        <div id="debug-log-container" class="debug-log-container"></div>
    </div>

    <!-- Debug Panel Toggle Button -->
    <button id="debug-toggle-btn" class="debug-toggle-btn" onclick="Logger.togglePanel()" title="Toggle debug panel (Ctrl+`)">
        üêõ
    </button>

    <script src="app.js?v=16"></script>
</body>
</html>
